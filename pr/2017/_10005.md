# _10005. Рефакторинг gulpfile

## 1. Описание к задаче

- Рефакторинг кода gulpfile.js
- Улучшение читаемости кода
- Избавления от лишних переменных и путей
- Изменение тасков
- Описание работы всех тасков

Ссылка в jira - https://jira.zoloto585.ru/browse/AMMA-38


## 2. Описание работ

### 2.1 Изменения в файлах

- gulpfile.js
- package.json
- Изменены пути импорта в папке `development\less\scaffolding` т.к. уже нет промежуточной сборки

### 2.2 Стандартный старт

Для старта после клонирования репозитория достаточно выполнить 2 команды:
- `gulp build`
- `gulp`

> В пункте **2.6** подробнее расписано о вариантах работы.


### 2.3 Конфиг

В объекте `config` должны храниться настройки для gulp модулей и пути для сборок

Отдельные ключи конфига можно перекрыть, создав в корне файл gulp.conf.json и описав в нем ключи конфига, которые нужно перекрыть.

Объект и json файл объединяются модулем `object-assign`

> Это может понадобиться в дальнейшем при использовании SFTP подключений

### 2.4 Хелпер

Объект хелпер содержит вспомогательные функции

#### getArg

Возвращает переданный таску флаг. Пример использования:

`gulp taskname --arg1 HELLO --arg2 BYE`

Пример подобного таска:

```
gulp.task('taskname', function () {
	let arg1 = helper.getArg('arg1');
	let arg2 = helper.getArg('arg2');

	console.log(arg1 +','+ arg2);
});
```

Вернет `HELLO, BYE`

#### getFolders
Возвращает список директорий. Используется в таске `js:pages`

### 2.5 Описание тасков

#### webserver
Запускает локальный сервер `browser-sync`. Входит в дефолтный таск. 

#### js:libs
Собирает js файлы библиотек из папки `development/js/libs` в `production/js`, минимизирует и обновляет локальный сервер

#### js:app
Собирает js файлы из папки `development/js/app` в `production/js`, минимизирует, создает sourcemaps и обновляет локальный сервер

#### js:pages
Собирает js файлы из подпапок `development/js/pages` в `production/js`, минимизирует, создает sourcemaps, переименовывает в имя папки и обновляет локальный сервер

#### js:views
Копирует файлы из папки `development/js/views` в `production/js/views` как есть и обновляет локальный сервер

#### js:adfox
Собирает отдельные js файлы из папки `development/js` в `production/js`, минимизирует, создает sourcemaps

#### js:msalnikov
Собирает js файлы из папки `development/js/inc` в `production/js`, минимизирует, создает sourcemaps и обновляет локальный сервер
> Предлагаю переименовать файл в более понятный

#### js:build
Запускает все js таски:

- js:libs
- js:libs
- js:app
- js:pages
- js:views
- js:adfox
- js:msalnikov

#### html:build
Собирает файлы из папки `development/htmls` в `development`. Использует `fileinclude`, перезагружает локальный сервер.

#### css:build
Собирает один минимизированный css файл в папку `production/css` используя `less` файлы с  импортами из папки `development/less/scaffolding`. Создает sourcemaps, перезагружает локальный сервер.

#### css:adfox
То же самое, что и предыдущий таск, но используя гораздо меньше импорт файлов.

#### build
Общая сборка, использует таски:

- js:build
- css:build
- css:adfox
- html:build

#### watch
Следит за отдельными папками js, less, html и вызывает нужные таски.

### 2.6 Применение тасков

#### 2.6.1 Начало работы

После клонирования репозитория файлов сборки еще нет, поэтому необходимо запустить команду `gulp build`, после чего в папке `production` появятся сборки нужных файлов.

> Важно: нельзя начинать работу со стандартной команды `gulp`, т.к. таск `watch` следит только за изменениями отдельных папок less, js, html, для ускорения процесса.

#### 2.6.2 Стандартный запуск
Для стандартной работы достаточно дефолтной комманды `gulp`, при которой запустится локальный сервер, откроется браузер со скриптом синхронизации и таск `watch`, следящий за изменением всех файлов, для которых есть таски. 

При сохранении файлов браузер обновляется, при этом не используя сторонние плагины для самого браузера.

#### 2.6.3 Запуск без использования сервера

Если локальный сервер не нужен можно запустить сразу `gulp watch`, который будет обновлять файлы в папке `production` при изменении папки `development`.
> При этом обновления браузера происходить не будет

Без локального сервера все пути к собранным файлам js и css должны иметь вид `../production/...`, например css должен быть такой:
`<link rel="stylesheet" href="../production/css/z585_all.min.css">`

#### 2.6.4 Таски-сборщики

Это таски, собирающие свой тип данных по отдельности, а так же таски, объединяющие их. Сборщики имеют следующую структуру:

- `build` - запускает все таски для проекта
  - `js:build` - запускает таски для javascript
      - `js:libs` - библиотеки
      - `js:app` - модули Z585 
      - `js:pages` - рендеры для отдельных страниц
      - `js:views` - шаблоны для отдельных страниц
      - `js:adfox` - библиотеки и плагины для adfox
      - `js:msalnikov` - скрипты, использующиеся на всех страницах
  - `html:build` - собирает файлы с инклудами из папки `development/htmls`
  - `css:build` - собирает less файлы, используя файлы с импортами из папки `development\less\scaffolding`
  - `css:adfox`: для adfox, то же самое, что и предыдущий таск, но с меньшим кол-вом импорта

Все таски используются в `watch`, кроме `build` 

> В дальнейшем возможно будут разбиты таски html css на подтаски и/или таски, исполняемые после них.


#### 2.6.5 Добавление файлов в проект

> Легенда: для добавления файлов в проект изменения в gulpfile.js вносить не нужно

##### JavaScript

- Для добавления jQuery плагина нужно поместить файл в папку `development\js\libs\jqueryteam` 
- Для добавления плагина на другой библиотеке или нативе нужно добавить файл в папку `development\js\libs\plugins`
- Для добавления рендера для страницы нужно создать файл `development\js\pages\my-page\render.js`
- Для добавления шаблона страницы нужно создать файл `development\js\views\my-template.js`
- Для добавления скрипта для всех страниц нужно добавить файл в папку `development\js\inc`

##### LESS

Для добавления своего файла нужно использовать подходящий файл из папки `development\less\scaffolding` и использовать там `@import`

Например нужно добавить на страницу каталог баннер. В файле `development\less\scaffolding\pages__catalog.less` добавляем строку:

`@import "../pages/catalog/my-banner.less";`

##### HTML

Для добавления файлов html файлов для сборки в папке `development` нужно создать файлы `development\htmls`. 

### 2.7 Локальный сервер

В этом разделе описана работа локального сервера и некоторые варианты его применения.

#### 2.7.1 Описание

Для локального сервера используется `browser-sync` и `connect-modrewrite`

Локальный сервер открывается по адресу localhost на 9000 порту без туннеля.

Север следит за двумя директориями development и production, т.к. в папке development хранятся собранные html файлы, а в production склеенные js и css. Для подключения файлов можно использовать любой из вариантов:

- `<link rel="stylesheet" href="css/z585_all.min.css">`
- `<link rel="stylesheet" href="/css/z585_all.min.css">`
- Или `<link rel="stylesheet" href="../production/css/z585_all.min.css">` если не использовать локальный сервер

Сервер использует `connect-modrewrite` для переопределения путей для картинок и шрифтов из папки `/bitrix/templates/zoloto/frontend` в папку `development`

#### 2.7.2 Туннель

Для удаленного просмотра локального хоста можно использовать туннель через localtunnel.me. Для этого в корне нужно создать файл gulp.conf.json и продублировать там объект `config.connect` изменив свойство `tunnel` на `true`

#### 2.7.3 Прокси

Если нужно связать локальный хост галпа со своим, например для использования серверных языков или апачевского реврайта можно использовать прокси. Для этого в файле gulp.conf.json нужно добавить в объект `config` свойство `proxy`, при этом не дублирую весь объект `connect` и указать адрес своего локального хоста.

## 3. Тестирование

Протестировано на сервере d02:
- css/z585_all.min.css
- js/ app.min.js
- js/libs.min.js

## 4. Комментарии разработчика

### 4.1 TODO

- Разобраться с development/js/libs
- Разобраться с development/js/app
- Упростить сборку через development/less/scaffolding
- Разобраться с таском js:msalnikov
- Возможно разбить на подтаски html и less сборщики
- npm: 
  - postcss (postcss-less-engine)
  - notify??
