# _10005. Рефакторинг gulpfile

## 1. Описание к задаче

- Рефакторинг кода gulpfile.js
- Улучшение читаемости кода
- Избавления от лишних переменных и путей
- Изменение тасков
- Описание работы всех тасков

Ссылка в jira - https://jira.zoloto585.ru/browse/AMMA-38


## 2. Описание работ

### 2.1 Изменения в файлах

- gulpfile.js
- package.json
- Изменены пути импорта в папке `development\less\scaffolding` т.к. уже нет промежуточной сборки

### 2.2 Конфиг

В объекте `config` должны храниться настройки для gulp модулей и пути для сборок

Отдельные ключи конфига можно перекрыть, создав в корне файл gulp.conf.json и описав в нем ключи конфига, которые нужно перекрыть.

Объект и json файл объединяются модулем `object-assign`

> Это может понадобиться в дальнейшем при использовании SFTP подключений

### 2.2.1 Конфиг сервера

Для локального сервера используется `browser-sync` и `connect-modrewrite`

Локальный сервер открывается по адресу localhost на 9000 порту без туннеля.

Север следит за двумя директориями development и production, т.к. в папке development хранятся собранные html файлы, а в production склеенные js и css. Для подключения файлов можно использовать любой из вариантов:

- `<link rel="stylesheet" href="css/z585_all.min.css">`
- `<link rel="stylesheet" href="/css/z585_all.min.css">`
- Или `<link rel="stylesheet" href="../production/css/z585_all.min.css">` если не использовать локальный сервер

Сервер использует `connect-modrewrite` для переопределения путей для картинок и шрифтов из папки `/bitrix/templates/zoloto/frontend` в папку `development`


### 2.3 Хелпер

Объект хелпер содержит вспомогательные функции

#### getArg

Возвращает переданный таску флаг. Пример использования:

`gulp taskname --arg1 HELLO --arg2 BYE`

Пример подобного таска:

```
gulp.task('taskname', function () {
	let arg1 = helper.getArg('arg1');
	let arg2 = helper.getArg('arg2');

	console.log(arg1 +','+ arg2);
});
```

Вернет `HELLO, BYE`

#### getFolders
Возвращает список директорий. Используется в таске `js:pages`

### 2.4 Описание тасков

#### webserver
Запускает локальный сервер `browser-sync`. Входит в дефолтный таск. 

#### js:libs
Собирает js файлы библиотек из папки `development/js/libs` в `production/js`, минимизирует и обновляет локальный сервер

#### js:app
Собирает js файлы из папки `development/js/app` в `production/js`, минимизирует, создает sourcemaps и обновляет локальный сервер

#### js:pages
Собирает js файлы из подпапок `development/js/pages` в `production/js`, минимизирует, создает sourcemaps, переименовывает в имя папки и обновляет локальный сервер

#### js:views
Копирует файлы из папки `development/js/views` в `production/js/views` как есть и обновляет локальный сервер

#### js:adfox
Собирает отдельные js файлы из папки `development/js` в `production/js`, минимизирует, создает sourcemaps

#### js:msalnikov
Собирает js файлы из папки `development/js/inc` в `production/js`, минимизирует, создает sourcemaps и обновляет локальный сервер
> Предлагаю переименовать файл в более понятный

#### js:build
Запускает все js таски:

- js:libs
- js:libs
- js:app
- js:pages
- js:views
- js:adfox
- js:msalnikov

#### html:build
Собирает файлы из папки `development/htmls` в `development`. Использует `fileinclude`, перезагружает локальный сервер.

#### css:build
Собирает один минимизированный css файл в папку `production/css` используя `less` файлы с  импортами из папки `development/less/scaffolding`. Создает sourcemaps, перезагружает локальный сервер.

#### css:adfox
То же самое, что и предыдущий таск, но используя гораздо меньше импорт файлов.

#### build
Общая сборка, использует таски:

- js:build
- css:build
- css:adfox
- html:build

#### watch
Следит за отдельными папками js, less, html и вызывает нужные таски.

## 3. Тестирование

## 4. Комментарии разработчика

